/**
 * @fileoverview Firestore Security Rules for the SeatingSavvy application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for event data and related entities. Each user can only access the data they own, based on the user ID in the path.
 *
 * Data Structure:
 * The Firestore database is structured as follows:
 * - /users/{userId}/events/{eventId}: Events created by a specific user.
 * - /users/{userId}/events/{eventId}/venues/{venueId}: Venues associated with an event.
 * - /users/{userId}/events/{eventId}/ticketTypes/{ticketTypeId}: Ticket types for an event.
 * - /users/{userId}/events/{eventId}/sections/{sectionId}: Sections within a venue for an event.
 * - /users/{userId}/events/{eventId}/sections/{sectionId}/seats/{seatId}: Seats within a section.
 *
 * Key Security Decisions:
 * - User-scoped subcollections are readable only by the owner.
 * - Data validation is relaxed to allow for rapid prototyping.
 * - All write operations require the user to be authenticated.
 *
 * Denormalization for Authorization:
 * The data model denormalizes the user ID and event ID into each subcollection to ensure authorization independence and avoid costly `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure access to user-specific event data.
     * @path /users/{userId}/events/{eventId}
     * @allow (create) User 'user123' creates a new event with 'id' and 'userId' fields both set to 'user123'.
     * @allow (get) User 'user123' retrieves event 'event456' they own.
     * @allow (list) User 'user123' lists events they own.
     * @allow (update) User 'user123' updates event 'event456' they own.
     * @allow (delete) User 'user123' deletes event 'event456' they own.
     * @deny (create) User 'user123' attempts to create an event for 'user456'.
     * @deny (get) User 'user123' attempts to retrieve event 'event456' owned by 'user456'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/events/{eventId} {
      // Is the user signed in?
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && request.resource.data.id == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secure access to venue data associated with an event.
     * @path /users/{userId}/events/{eventId}/venues/{venueId}
     * @allow (create) User 'user123' creates a new venue for event 'event456' they own.
     * @allow (get) User 'user123' retrieves venue 'venue789' for event 'event456' they own.
     * @allow (list) User 'user123' lists venues for event 'event456' they own.
     * @allow (update) User 'user123' updates venue 'venue789' for event 'event456' they own.
     * @allow (delete) User 'user123' deletes venue 'venue789' for event 'event456' they own.
     * @deny (create) User 'user456' attempts to create a venue for event 'event456' owned by 'user123'.
     * @deny (get) User 'user456' attempts to retrieve venue 'venue789' for event 'event456' owned by 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/events/{eventId}/venues/{venueId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Secure access to ticket type data associated with an event.
     * @path /users/{userId}/events/{eventId}/ticketTypes/{ticketTypeId}
     * @allow (create) User 'user123' creates a new ticket type for event 'event456' they own.
     * @allow (get) User 'user123' retrieves ticket type 'ticket101' for event 'event456' they own.
     * @allow (list) User 'user123' lists ticket types for event 'event456' they own.
     * @allow (update) User 'user123' updates ticket type 'ticket101' for event 'event456' they own.
     * @allow (delete) User 'user123' deletes ticket type 'ticket101' for event 'event456' they own.
     * @deny (create) User 'user456' attempts to create a ticket type for event 'event456' owned by 'user123'.
     * @deny (get) User 'user456' attempts to retrieve ticket type 'ticket101' for event 'event456' owned by 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/events/{eventId}/ticketTypes/{ticketTypeId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Secure access to section data associated with an event.
     * @path /users/{userId}/events/{eventId}/sections/{sectionId}
     * @allow (create) User 'user123' creates a new section for event 'event456' they own.
     * @allow (get) User 'user123' retrieves section 'sectionA' for event 'event456' they own.
     * @allow (list) User 'user123' lists sections for event 'event456' they own.
     * @allow (update) User 'user123' updates section 'sectionA' for event 'event456' they own.
     * @allow (delete) User 'user123' deletes section 'sectionA' for event 'event456' they own.
     * @deny (create) User 'user456' attempts to create a section for event 'event456' owned by 'user123'.
     * @deny (get) User 'user456' attempts to retrieve section 'sectionA' for event 'event456' owned by 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/events/{eventId}/sections/{sectionId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Secure access to seat data associated with a section.
     * @path /users/{userId}/events/{eventId}/sections/{sectionId}/seats/{seatId}
     * @allow (create) User 'user123' creates a new seat for section 'sectionA' of event 'event456' they own.
     * @allow (get) User 'user123' retrieves seat 'seat1' for section 'sectionA' of event 'event456' they own.
     * @allow (list) User 'user123' lists seats for section 'sectionA' of event 'event456' they own.
     * @allow (update) User 'user123' updates seat 'seat1' for section 'sectionA' of event 'event456' they own.
     * @allow (delete) User 'user123' deletes seat 'seat1' for section 'sectionA' of event 'event456' they own.
     * @deny (create) User 'user456' attempts to create a seat for section 'sectionA' of event 'event456' owned by 'user123'.
     * @deny (get) User 'user456' attempts to retrieve seat 'seat1' for section 'sectionA' of event 'event456' owned by 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/events/{eventId}/sections/{sectionId}/seats/{seatId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}